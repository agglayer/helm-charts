{{- $opSecrets := (lookup "v1" "Secret" .Release.Namespace "op-secrets") }}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "aggkit.fullname" . }}
  namespace: {{ .Release.Namespace }}
data:
  config.toml: |
    NetworkID = {{ .Values.config.l2.rollupId | int }}
    PathRWData = {{ .Values.storage.path | quote }}
    {{- if .Values.config.l1.rpcUrl }}
    L1URL = {{ .Values.config.l1.rpcUrl | quote }}
    {{- else }}
    L1URL = {{ index $opSecrets.data "l1RpcURL" | b64dec | quote }}
    {{- end }}
    L2URL = {{ .Values.config.l2.rpcURL | quote }}

    SequencerPrivateKeyPath = ""
    SequencerPrivateKeyPassword = ""

    polygonBridgeAddr = {{ .Values.config.bridgeAddress | quote }}

    rollupCreationBlockNumber = {{ .Values.config.l1.rollupBlockNumber | int }}
    rollupManagerCreationBlockNumber = {{ .Values.config.l1.rollupManagerBlockNumber | int }}
    genesisBlockNumber = {{ .Values.config.l1.rollupManagerBlockNumber | int }}

    [L1Config]
    chainId = {{ .Values.config.l1.chainId | int }}
    polygonZkEVMGlobalExitRootAddress = {{ .Values.config.l1.globalExitRootAddress | quote }}
    polygonRollupManagerAddress = {{ .Values.config.l1.rollupManagerAddress | quote }}
    polTokenAddress = {{ .Values.config.l1.polTokenAddress | quote }}
    polygonZkEVMAddress = {{ .Values.config.l1.rollupAddress | quote }}

    [L2Config]
    GlobalExitRootAddr = {{ .Values.config.l2.globalExitRootAddress | quote }}

    [Log]
    Environment = {{ .Values.config.log.environment | quote }}
    Level = {{ .Values.config.log.level | quote }}
    Outputs = ["stderr"]

    [RPC]
    Port = {{ .Values.container.ports.aggsender | int }}

    {{- if has "aggsender" .Values.config.components }}

    [AggSender]
    {{ if .Values.config.aggSender.privateKey.keyName }}
    AggsenderPrivateKey = {Method ="GCP", KeyName={{ .Values.config.aggSender.privateKey.keyName | quote }}}
    {{ else }}
    AggsenderPrivateKey = {Path = "/etc/aggkit/sequencer.keystore", Password = {{ index $opSecrets.data "sequencerPrivateKeyPassword" | b64dec | quote }}}
    {{ end }}

    CertificateSendInterval = {{ .Values.config.aggSender.certificateSendInterval | quote }}
    CheckSettledInterval = {{ .Values.config.aggSender.checkSettledInterval | quote }}
    MaxCertSize = {{ .Values.config.aggSender.maxCertSize | int }}
    SaveCertificatesToFilesPath = {{ .Values.config.aggSender.saveCertificatesToFilesPath | quote }}
    Mode={{ .Values.config.aggSender.mode | quote }}
    RequireNoFEPBlockGap = true

    {{ if .Values.config.aggSender.optimisticModeEnabled }}
    [AggSender.OptimisticModeConfig]
    SovereignRollupAddr = {{ .Values.config.l1.rollupAddress | quote }}
    # By default use the same key that aggsender  sign certs
    {{ if .Values.config.aggSender.privateKey.keyName }}
    TrustedSequencerKey = {Method ="GCP", KeyName={{ .Values.config.aggSender.privateKey.keyName | quote }}}
    {{ else }}
    TrustedSequencerKey = {Path = "/etc/aggkit/sequencer.keystore", Password = {{ index $opSecrets.data "sequencerPrivateKeyPassword" | b64dec | quote }}}
    {{ end }}
    OpNodeURL = "http://op-node:9545"
    RequireKeyMatchTrustedSequencer = true
    {{ end }}

    {{ if .Values.config.aggSender.mode | eq "AggchainProof" }}
    [AggSender.AggkitProverClient]
    URL = {{ .Values.config.aggSender.aggkitProverClient.url | quote }}
    UseTLS = {{ .Values.config.aggSender.aggkitProverClient.useTLS | quote }}
    {{ end }}

    [AggSender.AgglayerClient.GRPC]
    URL = {{ .Values.config.aggSender.agglayerClient.url | quote }}
    UseTLS = {{ .Values.config.aggSender.agglayerClient.useTLS | quote }}

    [AggSender.ValidatorClient]
    URL = {{ .Values.config.aggSender.validatorClient.url | quote }}

    {{- end }}

    {{- if has "aggoracle" .Values.config.components }}

    [AggOracle]
    EnableAggOracleCommittee = {{ .Values.config.aggOracle.enableAggOracleCommittee }}

    [AggOracle.EVMSender]
    GlobalExitRootL2 = {{ .Values.config.l2.globalExitRootAddress | quote }}

    {{ if .Values.config.aggOracle.enableAggOracleCommittee }}
    AggOracleCommitteeAddr = {{ .Values.config.aggOracle.aggOracleCommitteeAddr | quote }}
    {{ end }}

    [AggOracle.EVMSender.EthTxManager]
    {{ if .Values.config.aggOracle.privateKey.keyName }}
    PrivateKeys = [{Method ="GCP", KeyName={{ .Values.config.aggOracle.privateKey.keyName | quote }}}]
    {{ else }}
    PrivateKeys = [{Path = "/etc/aggkit/aggoracle.keystore", Password = {{ index $opSecrets.data "aggoraclePrivateKeyPassword" | b64dec | quote }}}]
    {{ end }}

    [AggOracle.EVMSender.EthTxManager.Etherman]
    L1ChainID = {{ .Values.config.l2.chainId | int }}

    {{- end }}

    {{- if or (has "bridge" .Values.config.components) (has "l1bridgesync" .Values.config.components) }}

    [ReorgDetectorL1]
    FinalizedBlock = {{ .Values.config.reorgDetectorL1.blockFinality | quote }}

    [BridgeL1Sync]
    BlockFinality = {{ .Values.config.bridgeL1Sync.blockFinality | quote }}

    {{- end }}

    [L1InfoTreeSync]
    SyncBlockChunkSize=1000

    [REST]
    Port = {{ .Values.container.ports.bridge | quote }}

    [L2GERSync]
    BlockFinality = "LatestBlock"

    {{- if has "aggsender-validator" .Values.config.components }}

    [Validator]
    EnableRPC = true
    Signer = {Method ="GCP", KeyName={{ .Values.config.validator.privateKey.keyName | quote }}}
    Mode={{ .Values.config.validator.mode | quote }}

    [Validator.ServerConfig]
    Host = "0.0.0.0"
    Port = {{ .Values.container.ports.validator }}
    MaxDecodingMessageSize = 1073741824  # 1GB

    [Validator.LerQuerierConfig]
    RollupManagerAddr = {{ .Values.config.l1.rollupManagerAddress | quote }}
    RollupCreationBlockL1 = {{ .Values.config.l1.rollupBlockNumber | int }}

    [Validator.AgglayerClient]
    Cached = true

    [Validator.AgglayerClient.ConfigurationCache]
    TTL = "15m"
    Capacity = 100

    [Validator.AgglayerClient.GRPC]
    URL = {{ .Values.config.validator.agglayerClient.url | quote }}
    UseTLS = {{ .Values.config.validator.agglayerClient.useTLS | quote }}
    {{ end }}

    [Prometheus]
    Enabled = {{ .Values.config.prometheus.enabled }}
    Host = {{ .Values.config.prometheus.host | quote }}
    Port = {{ .Values.container.ports.prometheus }}
