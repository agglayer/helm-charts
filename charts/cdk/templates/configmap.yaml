{{- $l1RpcURL := "" }}
{{- $sequencerPrivateKeyPassword := "" }}
{{- $aggregatorPrivateKeyPassword := "" }}

{{- $opSecrets := (lookup "v1" "Secret" .Release.Namespace "op-secrets") }}
{{- if $opSecrets.data }}
    {{- if (index $opSecrets.data "l1RpcURL") }}
        {{- $l1RpcURL = index $opSecrets.data "l1RpcURL" | b64dec }}
    {{- end }}
    {{- if (index $opSecrets.data "sequencerPrivateKeyPassword") }}
        {{- $sequencerPrivateKeyPassword = index $opSecrets.data "sequencerPrivateKeyPassword" | b64dec }}
    {{- end }}
    {{- if (index $opSecrets.data "aggregatorPrivateKeyPassword") }}
        {{- $aggregatorPrivateKeyPassword = index $opSecrets.data "aggregatorPrivateKeyPassword" | b64dec }}
    {{- end }}
{{- end }}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cdk.fullname" . }}
  namespace: {{ .Release.Namespace }}
data:
  config.toml: |
    PathRWData = {{ .Values.storage.path | quote }}
    L1URL = {{ $l1RpcURL | quote }}
    L2URL = {{ .Values.config.l2.rpcURL | quote }}
    AggLayerURL = {{ .Values.config.agglayerURL | quote }}

    ForkId = {{ .Values.config.forkId | int }}
    IsValidiumMode = {{ eq .Values.config.isValidium true }}

    ContractVersions = {{ .Values.config.contractsVersion | quote }}

    L2Coinbase = {{ .Values.config.l2.sequencerAddress | quote }}
    SequencerPrivateKeyPath =  {{ .Values.config.sequencerPrivateKeyPath | quote }}
    SequencerPrivateKeyPassword = {{ $sequencerPrivateKeyPassword | quote }}

    AggregatorPrivateKeyPath = {{ .Values.config.aggregatorPrivateKeyPath | quote }}
    AggregatorPrivateKeyPassword = {{ $aggregatorPrivateKeyPassword | quote }}
    SenderProofToL1Addr = {{ .Values.config.l2.agglayerAddress | quote }}
    polygonBridgeAddr = {{ .Values.config.bridgeAddress | quote }}

    RPCURL = {{ .Values.config.l2.rpcURL | quote }}
    WitnessURL = {{ .Values.config.l2.rpcURL | quote }}

    rollupCreationBlockNumber = {{ .Values.config.l1.rollupManagerBlockNumber | int }}
    rollupManagerCreationBlockNumber = {{ .Values.config.l1.rollupManagerBlockNumber | int }}
    genesisBlockNumber = {{ .Values.config.l1.rollupManagerBlockNumber | int }}

    [L1Config]
    chainId = {{ .Values.config.l1.chainId | int }}
    polygonZkEVMGlobalExitRootAddress = {{ .Values.config.l1.globalExitRootAddress | quote }}
    polygonRollupManagerAddress = {{ .Values.config.l1.rollupManagerAddress | quote }}
    polTokenAddress = {{ .Values.config.l1.polTokenAddress | quote }}
    polygonZkEVMAddress = {{ .Values.config.l1.rollupAddress | quote }}
      
    [L2Config]
    GlobalExitRootAddr = {{ .Values.config.l2.globalExitRootAddress | quote }}

    [Log]
    Environment = {{ .Values.config.log.environment | quote }}
    Level = {{ .Values.config.log.level | quote }}
    Outputs = ["stderr"]
          
    [AggSender]
    CertificateSendInterval = {{ .Values.config.aggSender.certificateSendInterval | quote }}
    CheckSettledInterval = {{ .Values.config.aggSender.checkSettledInterval | quote }}
  genesis.json: |-
{{ .Values.genesis | indent 4 }}
